

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Machine Scheduling (VM Scheduling) &#8212; latest</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="../_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/sphinx-book-theme.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../_static/fav32x32.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Multi Agent DQN for CIM" href="../examples/multi_agent_dqn_cim.html" />
    <link rel="prev" title="Bike Repositioning (Citi Bike)" href="citi_bike.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../index.html">
  
  <img src="../_static/logo.svg" class="logo" alt="logo">
  
  
  <h1 class="site-logo" id="site-title">latest</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../index.html">
   What is MARO?
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Installation
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../installation/pip_install.html">
   Package
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../installation/playground.html">
   Playground Docker Image
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../installation/grass_cluster_provisioning_on_azure.html">
   Grass Cluster Provisioning on Azure
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../installation/k8s_cluster_provisioning_on_azure.html">
   K8S Cluster Provisioning on Azure
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../installation/grass_cluster_provisioning_on_premises.html">
   Grass Cluster Provisioning in On-Premises Environment
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../installation/multi_processes_localhost_provisioning.html">
   Multi-processes Localhost Provisioning
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Scenarios
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="container_inventory_management.html">
   Container Inventory Management (CIM)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="citi_bike.html">
   Bike Repositioning (Citi Bike)
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Virtual Machine Scheduling (VM Scheduling)
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Examples
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../examples/multi_agent_dqn_cim.html">
   Multi Agent DQN for CIM
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../examples/greedy_policy_citi_bike.html">
   Greedy Policy for Citi Bike
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Key Components
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/simulation_toolkit.html">
   Simulation Toolkit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/data_model.html">
   Data Model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/event_buffer.html">
   Event Buffer
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/business_engine.html">
   Business Engine
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/rl_toolkit.html">
   RL Toolkit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/distributed_toolkit.html">
   Distributed Toolkit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/communication.html">
   Distributed Communication
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/orchestration.html">
   Distributed Orchestration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../key_components/dashboard_visualization.html">
   Dashboard Visualization
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  API Documents
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../apidoc/maro.html">
   maro package
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Theme by the <a href="https://ebp.jupyterbook.org">Executable Book Project</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/scenarios/vm_scheduling.rst.txt"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.rst</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/microsoft/maro"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/microsoft/maro/issues/new?title=Issue%20on%20page%20%2Fscenarios/vm_scheduling.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/microsoft/maro/edit/master/doc/source/scenarios/vm_scheduling.rst"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#resource-flow">
   Resource Flow
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vm-request">
     VM Request
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vm-allocation">
     VM Allocation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#oversubscription">
       Oversubscription
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#runtime-simulation">
     Runtime Simulation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#dynamic-utilization">
       Dynamic Utilization
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#real-time-energy-consumption">
       Real-time Energy Consumption
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#energy-curve">
         Energy Curve
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#overload">
       Overload
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#vm-deallocation">
     VM Deallocation
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#topologies">
   Topologies
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#azure-topologies">
     Azure Topologies
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#azure-2019-10k">
       azure.2019.10k
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#azure-2019-336k">
       azure.2019.336k
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#naive-baseline">
     Naive Baseline
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#random-allocation">
       Random Allocation
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#best-fit-allocation">
       Best-Fit Allocation
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#quick-start">
   Quick Start
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data-preparation">
     Data Preparation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#customize-dataset">
       Customize Dataset
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#build-command">
       Build Command
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#environment-interface">
     Environment Interface
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#decisionpayload">
       DecisionPayload
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Action
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#example">
     Example
    </a>
   </li>
  </ul>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="virtual-machine-scheduling-vm-scheduling">
<h1>Virtual Machine Scheduling (VM Scheduling)<a class="headerlink" href="#virtual-machine-scheduling-vm-scheduling" title="Permalink to this headline">¶</a></h1>
<p>In 21th century, the business needs of cloud computing are dramatically increasing.
During the cloud service, users request Virtual Machine (VM) with a certain amount of resources (eg. CPU, memory, etc).
The following important issue is how to allocate the physical resources for these VMs?
The VM Scheduling scenario aims to find a better solution of the VM scheduling problem
in cloud data centers.
Now, consider a specific time, the number of VM
requests and arrival pattern is fixed. Given a cluster of limited physical
machines(PM) with limited physical resources, different VM allocation strategies result in
different amount of
successful completion and different operating cost of the data center. For cloud providers, a
good VM allocation strategy can maximize the resource utilization and thus can increase the profit by
providing more VMs to users. For cloud users, a good VM allocation strategy can
minimize the VM response time and have a better using experience. We hope this scenario can meet
the real needs and provide you with a demand simulation that is closest to the real situation.</p>
<div class="section" id="resource-flow">
<h2>Resource Flow<a class="headerlink" href="#resource-flow" title="Permalink to this headline">¶</a></h2>
<p>In this scenario, the physical resources in each PM are the
central resource, which currently includes the physical cores and memory. A full
resource life cycle always contains the steps below:</p>
<ul class="simple">
<li><p>Coming VM requests ask for a certain amount of resources. Resource requirements are varied
based on the different VM requests.</p></li>
<li><p>Based on the scheduling agent’s strategy, the VM will be allocated to and be created
in a specified PM as long as that PM’s remaining resources are enough.</p></li>
<li><p>The VM’s resource utilization changes dynamically and the PM’s real-time energy consumption
will be simulated in the runtime simulation.</p></li>
<li><p>After a period of execution, the VM completes its tasks. The simulator will release the resources
allocated to this VM and deallocate this VM from the PM.
Finally, the resource is free and is ready to serve the next VM request.</p></li>
</ul>
<div class="section" id="vm-request">
<h3>VM Request<a class="headerlink" href="#vm-request" title="Permalink to this headline">¶</a></h3>
<p>In the VM scheduling scenario, the VM requests are uniformly sampled from real
workloads. As long as the original dataset is large enough and the sample ratio
is not too small, the sampled VM requests can follow a similar distribution to the
original ones.</p>
<p>Given a fixed time interval, a VM request will arise according to the real VM workload data.
The request contains the VM information, such as the subscription id, the deployment id, and the
VM category, VM’s required resources, including the required CPU cores and
the required memory, and the remaining buffer time.</p>
<ul class="simple">
<li><p>Whenever receive a VM request, the MARO simulator will first calculate the
remaining resources of each PM, filtering out the valid PMs (valid PMs means that the remaining
resources of PM are enough for the required resources of the VM).</p></li>
<li><p>Then, the simulator delivers all valid PMs and the required resources of the awaiting VM
to the VM scheduler (agent) for a decision.</p></li>
</ul>
<p>We have two categories of VM. One is interactive, and the other one is
delay-insensitive.</p>
<ul class="simple">
<li><p>Interactive: The interactive VMs usually require low response time, so we set this kind of VMs can
only be allocated to the non-oversubscribable PM server.</p></li>
<li><p>Delay-insensitive: The delay-insensitive VMs usually serve for batch-tasks or development workload. This kind of VMs can
be allocated to the over-subscribable PM server.</p></li>
</ul>
</div>
<div class="section" id="vm-allocation">
<h3>VM Allocation<a class="headerlink" href="#vm-allocation" title="Permalink to this headline">¶</a></h3>
<p>Based on the valid PM list, the historical information recorded by the simulator, and the detailed
required resources of the VM, the VM scheduler (decision agent) will make the decision according to its
allocation strategy.</p>
<p>There are two types of meaningful actions:</p>
<ul class="simple">
<li><p>Deliver a valid PM ID to the simulator.</p></li>
<li><p>Postpone the VM request, which will leave this request to be handled later if
the remaining buffer time is enough.</p></li>
</ul>
<p>See the detailed attributes of <a class="reference external" href="#id1">Action</a>.</p>
<div class="section" id="oversubscription">
<h4>Oversubscription<a class="headerlink" href="#oversubscription" title="Permalink to this headline">¶</a></h4>
<p>To maximize each PM’s utilization, cloud providers will oversubscribe the physical resource.
Considering the various service level, the physical machines are then divided into the over-subscribable ones and non-oversubscribable ones.
For the over-subscription, there are several parameters can be set in the config.yml.
In our scenario, there are two resources could be oversubscribed, CPU and memory, so we have two maximum oversubscription rate can be set.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_CPU_OVERSUBSCRIPTION_RATE</span></code>: The oversubscription rate of CPU. For example, the default setting
is 1.15, that means each PM can be allocated at most 1.15 times of its resource capacity.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_MEM_OVERSUBSCRIPTION_RATE</span></code>: The oversubscription rate of memory. Similar to the CPU rate.</p></li>
</ul>
<p>To protect the PM from the overloading, we need to consider the CPU utilization. The <code class="docutils literal notranslate"><span class="pre">MAX_UTILIZATION_RATE</span></code>
is used as the security mechanism, that can be set in the config.yml.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_UTILIZATION_RATE</span></code>: The default setting is 1, which means that when filtering the valid PMs,
the maximum allowed physical CPU utilization is 100%.</p></li>
</ul>
</div>
</div>
<div class="section" id="runtime-simulation">
<h3>Runtime Simulation<a class="headerlink" href="#runtime-simulation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="dynamic-utilization">
<h4>Dynamic Utilization<a class="headerlink" href="#dynamic-utilization" title="Permalink to this headline">¶</a></h4>
<p>To make the simulated environment closest to the real situation. We also simulate the resource utilization
(currently only CPU utilization) of each VM. The CPU utilization of the VM varies every tick based on
the real VM workload readings. We will also regularly update the real-time resource utilization of
each PM based on the live VMs in it.</p>
</div>
<div class="section" id="real-time-energy-consumption">
<h4>Real-time Energy Consumption<a class="headerlink" href="#real-time-energy-consumption" title="Permalink to this headline">¶</a></h4>
<p>One of the most important characteristics that cloud providers concern is the energy consumption of the
data center. The different VM allocation can result in different energy consumption of the PM cluster,
we also simulate the energy usage based on the CPU utilization.</p>
<div class="section" id="energy-curve">
<h5>Energy Curve<a class="headerlink" href="#energy-curve" title="Permalink to this headline">¶</a></h5>
<a class="reference external image-reference" href="../images/scenario/vm.energy_curve.svg"><img alt="data center energy curve" src="../_images/vm.energy_curve.svg" /></a>
<p>As we mention before, the lower energy consumption of the PMs, the lower cost to maintain the physical
servers. In our simulation, we currently use a non-linear energy curve like the one in the above
<a class="reference external" href="https://dl.acm.org/doi/10.1145/1273440.1250665">figure</a> to
simulate the energy based on the CPU utilization.</p>
</div>
</div>
<div class="section" id="overload">
<h4>Overload<a class="headerlink" href="#overload" title="Permalink to this headline">¶</a></h4>
<p>Since the VM’s CPU utilization varies along the time, when enabling the oversubscription, it might
happen that the sum of VM’s CPU usage exceed the capacity of the physical resource. This situation called
overload.</p>
<p>Overloading may lead to VM’s performance degradation or service level agreements (SLAs) violations
in real production (We will support these features in the future).
Currently, for the situation of overloading, we only support quiescing (killing) all VMs or just recording
the times of overloading, which can also be set in config.yml.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">KILL_ALL_VMS_IF_OVERLOAD</span></code>: If this action is enable,
once overloading happens, all VMs located at the overloading PMs will be deallocated. To consider the
effect of overloading, we will still count the energy consumed by the high utilization.
The impact of the quiescing action on the PM’s utilization will be reflected in the next tick.</p></li>
</ul>
<p>No matter enable killing all VMs or not, we will calculate the number of overload PMs and the number
of overload VMs. These two metrics are cumulative values and will be recorded as the environment metrics.</p>
</div>
</div>
<div class="section" id="vm-deallocation">
<h3>VM Deallocation<a class="headerlink" href="#vm-deallocation" title="Permalink to this headline">¶</a></h3>
<p>The MARO simulator regularly checks the finished VMs in every tick.
A finished VM means that it goes through a complete life cycle, is ready to be terminated, and
the resources it occupies will be available again in the end.
The simulator will then release the finished VM’s resources, and finally remove the VM from the PM.</p>
</div>
</div>
<div class="section" id="topologies">
<h2>Topologies<a class="headerlink" href="#topologies" title="Permalink to this headline">¶</a></h2>
<div class="section" id="azure-topologies">
<h3>Azure Topologies<a class="headerlink" href="#azure-topologies" title="Permalink to this headline">¶</a></h3>
<p>The original data comes from <a class="reference external" href="https://github.com/Azure/AzurePublicDataset">Azure public dataset</a>.
The dataset contains real Azure VM workloads, including the information of VMs and their
utilization readings in 2019 lasting for 30 days. Total number of VM recorded is 2,695,548.</p>
<p>In our scenario, we pre-processed the AzurePublicDatasetV2.
The detailed information of the data schema can be found
<a class="reference external" href="https://github.com/Azure/AzurePublicDataset/blob/master/AzurePublicDatasetV2.md">here</a>.
After pre-processed, the data contains</p>
<ul class="simple">
<li><p>Renumbered VM ID</p></li>
<li><p>VM cores and memory(GB) requirements</p></li>
<li><p>Real VM creation and deletion time (converted to the tick, 1 tick means 5 minutes in real time)</p></li>
</ul>
<p>As for the utilization readings part, we sort the renumbered VM ID and CPU utilization pairs by the timestamp (tick).</p>
<p>To provide system workloads from light to heavy, two kinds of simple topologies are designed and
provided in VM Scheduling scenario.</p>
<div class="section" id="azure-2019-10k">
<h4>azure.2019.10k<a class="headerlink" href="#azure-2019-10k" title="Permalink to this headline">¶</a></h4>
<p>Uniformly random sample.</p>
<ul class="simple">
<li><p>Total number of VMs: 10,000</p></li>
<li><p>Average number of concurrent VMs: 835.7</p></li>
<li><p>Average number of CPU cores requested: 3.8</p></li>
<li><p>Average memory requested: 15.9 GB</p></li>
<li><p>Average CPU utilization: 15.7 %</p></li>
</ul>
<p>PM setting (Given by the /[topologies]/config.yml):</p>
<ul class="simple">
<li><p>Amount: 100</p></li>
<li><p>CPU Cores: 32</p></li>
<li><p>Memory: 128 GB</p></li>
</ul>
</div>
<div class="section" id="azure-2019-336k">
<h4>azure.2019.336k<a class="headerlink" href="#azure-2019-336k" title="Permalink to this headline">¶</a></h4>
<p>Uniformly random sample.</p>
<ul class="simple">
<li><p>Total number of VMs: 336,000</p></li>
<li><p>Average number of concurrent VMs: 28,305.9</p></li>
<li><p>Average number of CPU cores requested: 3.8</p></li>
<li><p>Average memory requested: 16.1 GB</p></li>
<li><p>Average CPU utilization: 15.6 %</p></li>
</ul>
<p>PM setting (Given by the /[topologies]/config.yml):</p>
<ul class="simple">
<li><p>Amount: 880</p></li>
<li><p>CPU Cores: 16</p></li>
<li><p>Memory: 112 GB</p></li>
</ul>
</div>
</div>
<div class="section" id="naive-baseline">
<h3>Naive Baseline<a class="headerlink" href="#naive-baseline" title="Permalink to this headline">¶</a></h3>
<p>Belows are the final environment metrics of the method <strong>Random Allocation</strong> and
<strong>Best-Fit Allocation</strong> in different topologies.
For each experiment, we setup the environment and test for a duration of 30 days.
Besides, we use several settings of PM capacity to test performance under different
initial resources.</p>
<div class="section" id="random-allocation">
<h4>Random Allocation<a class="headerlink" href="#random-allocation" title="Permalink to this headline">¶</a></h4>
<p>Randomly allocate to a valid PM.</p>
<table class="table">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Topology</p></th>
<th class="head"><p>PM Setting</p></th>
<th class="head"><p>Total VM Requests</p></th>
<th class="head"><p>Total Energy Consumption</p></th>
<th class="head"><p>Successful Allocation</p></th>
<th class="head"><p>Successful completion</p></th>
<th class="head"><p>Failed Allocation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Azure.2019.10k</p></td>
<td><p>100 PMs, 32 Cores, 128 GB</p></td>
<td><p>10,000</p></td>
<td><p>2,430,651.6</p></td>
<td><p>9,850</p></td>
<td><p>9,030</p></td>
<td><p>150</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>100 PMs, 16 Cores, 112 GB</p></td>
<td><p>10,000</p></td>
<td><p>2,978,445.0</p></td>
<td><p>8,011</p></td>
<td><p>7,411</p></td>
<td><p>1,989</p></td>
</tr>
<tr class="row-even"><td><p>Azure.2019.336k</p></td>
<td><p>880 PMs, 32 Cores, 128 GB</p></td>
<td><p>335,985</p></td>
<td><p>26,681,249.7</p></td>
<td><p>176,468</p></td>
<td><p>165,715</p></td>
<td><p>159,517</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>880 PMs, 16 Cores, 112 GB</p></td>
<td><p>335,985</p></td>
<td><p>26,367,238.7</p></td>
<td><p>92,885</p></td>
<td><p>87,153</p></td>
<td><p>243,100</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="best-fit-allocation">
<h4>Best-Fit Allocation<a class="headerlink" href="#best-fit-allocation" title="Permalink to this headline">¶</a></h4>
<p>Choose the valid PM with the least remaining resources (only consider CPU cores here).</p>
<table class="table">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Topology</p></th>
<th class="head"><p>PM Setting</p></th>
<th class="head"><p>Total VM Requests</p></th>
<th class="head"><p>Total Energy Consumption</p></th>
<th class="head"><p>Successful Allocation</p></th>
<th class="head"><p>Successful completion</p></th>
<th class="head"><p>Failed Allocation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Azure.2019.10k</p></td>
<td><p>100 PMs, 32 Cores, 128 GB</p></td>
<td><p>10,000</p></td>
<td><p>2,395,328.7</p></td>
<td><p>10,000</p></td>
<td><p>9,180</p></td>
<td><p>0</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>100 PMs, 16 Cores, 112 GB</p></td>
<td><p>10,000</p></td>
<td><p>2,987,086.6</p></td>
<td><p>7,917</p></td>
<td><p>7,313</p></td>
<td><p>2,083</p></td>
</tr>
<tr class="row-even"><td><p>Azure.2019.336k</p></td>
<td><p>880 PMs, 32 Cores, 128 GB</p></td>
<td><p>335,985</p></td>
<td><p>26,695,470.8</p></td>
<td><p>171,044</p></td>
<td><p>160,495</p></td>
<td><p>164,941</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>880 PMs, 16 Cores, 112 GB</p></td>
<td><p>335,985</p></td>
<td><p>26,390,972.9</p></td>
<td><p>92,263</p></td>
<td><p>86,600</p></td>
<td><p>243,722</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="section" id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Permalink to this headline">¶</a></h2>
<div class="section" id="data-preparation">
<h3>Data Preparation<a class="headerlink" href="#data-preparation" title="Permalink to this headline">¶</a></h3>
<p>When the environment is first created, the system will automatically trigger the pipeline to download
and process the data files. Afterwards, if you want to run multiple simulations, the system will detect
whether the processed data files exist or not. If not, it will then trigger the pipeline again. Otherwise,
the system will reuse the processed data files.</p>
<div class="section" id="customize-dataset">
<h4>Customize Dataset<a class="headerlink" href="#customize-dataset" title="Permalink to this headline">¶</a></h4>
<p>If you want to use your own dataset, you need to prepare two csv files, <code class="docutils literal notranslate"><span class="pre">vm_table</span></code> and <code class="docutils literal notranslate"><span class="pre">cpu_readings_file</span></code>.
Below is the data schema and the format that you need to follow.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">vm_table</span></code>:</p>
<ul>
<li><p>vm_id: int. The id number of VMs.</p></li>
<li><p>sub_id: int. The subscription id of VMs.</p></li>
<li><p>deploy_id: int. The deployment id of VMs.</p></li>
<li><p>timestamp: int. The timestamp of VM’s creation time.</p></li>
<li><p>vm_lifetime: int. The lifetime of VMs. Lifetime equals the deletion time - creation time (timestamp) + 1.</p></li>
<li><p>vm_deleted: int. The timestamp of VM’s deletion time.</p></li>
<li><p>vm_category: int. The category of VMs. Currently, we have three categories of VM:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Delay-Insensitive</span></code>: The VMs workload that could be delayed, such as batch tasks or test workload.
This kind of VMs could be allocated to the over-subscribable PM. Store as <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Interactive</span></code>: The VMs workload that are interactive, which need user response in time. This kind
of VMs could only allocated to the non-oversubscribable PMs. Store as <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Unknown</span></code>. Unknown types. To avoid the overloading, this kind of VMs are treated as the interactive ones,
which could only allocated to the non-oversubscribable PMs. Store as <code class="docutils literal notranslate"><span class="pre">2</span></code>.</p></li>
</ul>
</li>
<li><p>vm_cpu_cores: int. The CPU cores of VMs.</p></li>
<li><p>vm_memory: int. The memory of VMs.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">cpu_readings_file</span></code>:</p>
<ul>
<li><p>timestamp: int. The timestamp. Should be matched with the timestamp in <code class="docutils literal notranslate"><span class="pre">vm_table</span></code>.</p></li>
<li><p>vm_id: int. The id number of VMs. Should be matched with the ids in <code class="docutils literal notranslate"><span class="pre">vm_table</span></code>.</p></li>
<li><p>cpu_utilization: float. The utilization of VM CPU. Store in the unit of percentage (%).</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="build-command">
<h4>Build Command<a class="headerlink" href="#build-command" title="Permalink to this headline">¶</a></h4>
<p>After preparing two files as the above formats. You need to convert them to binary files.
We provide the <code class="docutils literal notranslate"><span class="pre">build</span></code> command to build your own CSV dataset to binary files
that the MARO simulator can use. Currently, there are three required arguments for the data <code class="docutils literal notranslate"><span class="pre">build</span></code> command:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">--meta</span></code>: required, used to specify the path of the meta file. In default, the meta files are under</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>~/.maro/data/vm_scheduling/meta/
</pre></div>
</div>
<p>The source columns that to be converted and
the data type of each columns should be specified in the meta file.</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--file</span></code>: required, used to specify the path of the source CSV data file(s). If multiple source CSV data files are needed,
you can list all the full paths of the source files in a specific file and use a <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> symbol to specify it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--output</span></code>: required, used to specify the path of the target binary file.</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>maro data build --meta <span class="nv">$PATH_TO_META_FILE</span> --file <span class="nv">$PATH_TO_CSV_FILE</span>  --output <span class="nv">$PATH_TO_OUTPUT_FILE</span>
</pre></div>
</div>
<p>For example,</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>maro data build --meta ~/.maro/data/vm_scheduling/meta/vmtable.yml  --file ~/.maro/data/vm_scheduling/.build/azure.2019.10k/vmtable.bin --output <span class="nv">$PWD</span>/vmtable.bin
</pre></div>
</div>
<p>After building the binary files. Specify the direct path of <code class="docutils literal notranslate"><span class="pre">VM_TABLE</span></code> and <code class="docutils literal notranslate"><span class="pre">CPU_READINGS</span></code>
in the config.yml under the topologies directories. Then you can use your own dataset to run the simulation.</p>
</div>
</div>
<div class="section" id="environment-interface">
<h3>Environment Interface<a class="headerlink" href="#environment-interface" title="Permalink to this headline">¶</a></h3>
<p>Before starting interaction with the environment, we need to know the definition of <code class="docutils literal notranslate"><span class="pre">DecisionPayload</span></code> and
<code class="docutils literal notranslate"><span class="pre">Action</span></code> in VM Scheduling scenario first. Besides, you can query the environment
<a class="reference external" href="../key_components/data_model.html#advanced-features">snapshot list</a> to get more
detailed information for the decision making.</p>
<div class="section" id="decisionpayload">
<h4>DecisionPayload<a class="headerlink" href="#decisionpayload" title="Permalink to this headline">¶</a></h4>
<p>Once the environment need the agent’s response to promote the simulation, it will throw an <code class="docutils literal notranslate"><span class="pre">PendingDecision</span></code>
event with the <code class="docutils literal notranslate"><span class="pre">DecisionPayload</span></code>. In the scenario of VM Scheduling, the information of <code class="docutils literal notranslate"><span class="pre">DecisionPayload</span></code> is
listed as below:</p>
<ul class="simple">
<li><p><strong>valid_pms</strong> (List[int]): The list of the PM ID that is considered as valid (Its CPU and memory resource is enough for the incoming VM request).</p></li>
<li><p><strong>vm_id</strong> (int): The VM ID of the incoming VM request (VM request that is waiting for the allocation).</p></li>
<li><p><strong>vm_cpu_cores_requirement</strong> (int): The CPU cores that is requested by the incoming VM request.</p></li>
<li><p><strong>vm_memory_requirement</strong> (int): The memory resource that is requested by the incoming VM request.</p></li>
<li><p><strong>remaining_buffer_time</strong> (int): The remaining buffer time for the VM allocation. The VM request will be treated as failed when the remaining_buffer_time is spent. The initial buffer time budget can be set in the config.yml.</p></li>
</ul>
</div>
<div class="section" id="id1">
<h4>Action<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Once get a <code class="docutils literal notranslate"><span class="pre">PendingDecision</span></code> event from the environment, the agent should respond with an Action. Valid
<code class="docutils literal notranslate"><span class="pre">Action</span></code> includes:</p>
<ul>
<li><p><strong>None</strong>. It means do nothing but ignore this VM request.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AllocateAction</span></code>: If the MARO simulator receives the <code class="docutils literal notranslate"><span class="pre">AllocateAction</span></code>, the VM’s creation time will be
fixed at the tick it receives. Besides, the simulator will update the workloads (the workloads include
CPU cores, the memory, and the energy consumption) of the target PM.
The <code class="docutils literal notranslate"><span class="pre">AllocateAction</span></code> includes:</p>
<ul class="simple">
<li><p>vm_id (int): The ID of the VM that is waiting for the allocation.</p></li>
<li><p>pm_id (int): The ID of the PM where the VM is scheduled to allocate to.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">PostponeAction</span></code>: If the MARO simulator receives the <code class="docutils literal notranslate"><span class="pre">PostponeAction</span></code>, it will calculate the
remaining buffer time.</p>
<ul class="simple">
<li><p>If the time is still enough, the simulator will re-generate a new request
event and insert it to the corresponding tick (based on the <code class="docutils literal notranslate"><span class="pre">Postpone</span> <span class="pre">Step</span></code> and <code class="docutils literal notranslate"><span class="pre">DELAY_DURATION</span></code>).
The <code class="docutils literal notranslate"><span class="pre">DecisionPayload</span></code> of the new requirement event only differs in the remaining buffer time from the
old ones.</p></li>
<li><p>If the time is exhausted, the simulator will note it as a failed allocation.</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">PostponeAction</span></code> includes:</p>
<ul class="simple">
<li><p>vm_id (int): The ID of the VM that is waiting for the allocation.</p></li>
<li><p>postpone_step (int): The number of times that the allocation to be postponed. The unit
is <code class="docutils literal notranslate"><span class="pre">DELAY_DURATION</span></code>. 1 means delay 1 <code class="docutils literal notranslate"><span class="pre">DELAY_DURATION</span></code>, which can be set in the config.yml.</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>Here we will show you a simple example of interaction with the environment in random mode, we
hope this could help you learn how to use the environment interfaces:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">random</span>

<span class="kn">from</span> <span class="nn">maro.simulator</span> <span class="kn">import</span> <span class="n">Env</span>
<span class="kn">from</span> <span class="nn">maro.simulator.scenarios.vm_scheduling</span> <span class="kn">import</span> <span class="n">AllocateAction</span><span class="p">,</span> <span class="n">DecisionPayload</span><span class="p">,</span> <span class="n">PostponeAction</span>

<span class="c1"># Initialize an Env for vm_scheduling scenario</span>
<span class="n">env</span> <span class="o">=</span> <span class="n">Env</span><span class="p">(</span>
  <span class="n">scenario</span><span class="o">=</span><span class="s2">&quot;vm_scheduling&quot;</span><span class="p">,</span>
  <span class="n">topology</span><span class="o">=</span><span class="s2">&quot;azure.2019.10k&quot;</span><span class="p">,</span>
  <span class="n">start_tick</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
  <span class="n">durations</span><span class="o">=</span><span class="mi">8638</span><span class="p">,</span>
  <span class="n">snapshot_resolution</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>

<span class="n">metrics</span><span class="p">:</span> <span class="nb">object</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">decision_event</span><span class="p">:</span> <span class="n">DecisionPayload</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">is_done</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">action</span><span class="p">:</span> <span class="n">AllocateAction</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Start the env with a None Action</span>
<span class="n">metrics</span><span class="p">,</span> <span class="n">decision_event</span><span class="p">,</span> <span class="n">is_done</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<span class="k">while</span> <span class="ow">not</span> <span class="n">is_done</span><span class="p">:</span>
    <span class="n">valid_pm_num</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">decision_event</span><span class="o">.</span><span class="n">valid_pms</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">valid_pm_num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># No valid PM now, postpone.</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">PostponeAction</span> <span class="o">=</span> <span class="n">PostponeAction</span><span class="p">(</span>
            <span class="n">vm_id</span><span class="o">=</span><span class="n">decision_event</span><span class="o">.</span><span class="n">vm_id</span><span class="p">,</span>
            <span class="n">postpone_step</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Randomly choose an available PM.</span>
        <span class="n">random_idx</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">valid_pm_num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">pm_id</span> <span class="o">=</span> <span class="n">decision_event</span><span class="o">.</span><span class="n">valid_pms</span><span class="p">[</span><span class="n">random_idx</span><span class="p">]</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">AllocateAction</span> <span class="o">=</span> <span class="n">AllocateAction</span><span class="p">(</span>
            <span class="n">vm_id</span><span class="o">=</span><span class="n">decision_event</span><span class="o">.</span><span class="n">vm_id</span><span class="p">,</span>
            <span class="n">pm_id</span><span class="o">=</span><span class="n">pm_id</span>
        <span class="p">)</span>
    <span class="n">metrics</span><span class="p">,</span> <span class="n">decision_event</span><span class="p">,</span> <span class="n">is_done</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[Random] Topology: azure.2019.10k. Total ticks: 8638. Start tick: 0&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">metrics</span><span class="p">)</span>
</pre></div>
</div>
<p>Jump to <a class="reference external" href="https://github.com/microsoft/maro/tree/master/notebooks/vm_scheduling/interact_with_environment.ipynb">this notebook</a> for a quick experience.</p>
</div>
</div>
</div>


              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="citi_bike.html" title="previous page">Bike Repositioning (Citi Bike)</a>
    <a class='right-next' id="next-link" href="../examples/multi_agent_dqn_cim.html" title="next page">Multi Agent DQN for CIM</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By MARO Team<br/>
        
            &copy; Copyright 2020 Microsoft.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="../_static/js/index.js"></script>
    
  </body>
</html>